using System;
using System.Collections.Generic;
using System.Collections;
using System.ComponentModel;
using System.Drawing;
using System.IO;
using System.Data;
using System.Text;
using System.Windows.Forms;
using FakPlusz.Alapfunkciok;
using FakPlusz;
using FakPlusz.Alapcontrolok;
using FakPlusz.UserAlapcontrolok;
using FakPlusz.Formok;
using FakPlusz.VezerloFormok;

namespace Vezir
{
    public partial class Koltsszla : Szulogyerekvaltozasok
    {
        private VezerloControl VezerloControl;
        private Controltipus szla;
        private Controltipus szlatetel;
        private Tablainfo szlainfo;
        private Tablainfo tetelinfo;
        private Tablainfo afainfo;
        private Tablainfo partnerinfo;
        private Tablainfo koltsfocsopinfo;
        private Tablainfo koltsalcsopinfo;
        private Tablainfo koltscsopinfo;
        private Tablainfo koltsegkodok;
        private Tablainfo termfocsopinfo;
        private Tablainfo termalcsopinfo;
        private Tablainfo termcsopinfo;
        private Tablainfo termekkodok;
        private Tablainfo koltsfocsopalcsop;
        private Tablainfo koltsalcsopcsop;
        private Tablainfo koltscsopkod;
        private Tablainfo termfocsopalcsop;
        private Tablainfo termalcsopcsop;
        private Tablainfo termcsopkod;
        private Tablainfo szazalekinfo;
        private Tablainfo szazalekosfeloszt;
        private Decimal maradekossz = 0;
        private Decimal bruttoossz = 0;
        private Decimal bruttoosszegzes = 0;
        private Decimal afaszazalek = 0;
        private Decimal egynetto = 0;
        private Decimal egybrutto = 0;
        private MezoTag nettotag;
        private MezoTag bruttotag;
        private MezoTag koltsegkodtag;
        private MezoTag afakulcstag;
        private MezoTag partnertag;
        private MezoTag koltsfocsoptag;
        private MezoTag koltsalcsoptag;
        private MezoTag koltscsoptag;
        private MezoTag termkodtag;
        private MezoTag termekfocsoptag;
        private MezoTag termekalcsoptag;
        private MezoTag termekcsoptag;
        private string afaid;
        private string partnerid;
        private string egykoltsegkod = "";
        private string egykoltsegid = "";
        private UjPartner ujpartnerform = null;
        private string[] semaidk = null;
        private string[] afaidk = null;
        private string egyafa = "";
        private bool sajateventtilt = false;
        private string afakod;
        private string afaszov;
        public Koltsszla(FakUserInterface fak, VezerloControl hivo, Vezerloinfo aktivvezerles)
        {
            InitializeComponent();
            ParameterAtvetel(fak, hivo, aktivvezerles);
            VezerloControl = hivo;
            panel2.Parent.Controls.Remove(panel2);
            panel111.Parent.Controls.Remove(panel111);
            SzuloGyerekInit();
            toolStripfo.Visible = false;
            szla = ControltipusCollection.Find(groupBox1);
            szlatetel = ControltipusCollection.Find(groupBox122);
            szlainfo = szla.Tablainfo;
            tetelinfo = szlatetel.Tablainfo;
            afainfo = fak.GetKodtab("C", "Afa");
            nettotag = (MezoTag)netto.Tag;
            bruttotag = (MezoTag)brutto.Tag;
            koltsfocsoptag = (MezoTag)koltsfocsop.Tag;
            koltsalcsoptag = (MezoTag)koltsalcsop.Tag;
            koltscsoptag = (MezoTag)koltscsop.Tag;
            koltsegkodtag = (MezoTag)koltsegkod.Tag;
            partnertag = (MezoTag)partner.Tag;
            termkodtag = (MezoTag)termekkod.Tag;
            termekcsoptag = (MezoTag)termcsop.Tag;
            termekalcsoptag = (MezoTag)termalcsop.Tag;
            termekfocsoptag = (MezoTag)termfocsop.Tag;
            partnerinfo = FakUserInterface.GetBySzintPluszTablanev("C", "PARTNER");
            koltsfocsopinfo = FakUserInterface.GetKodtab("C", "Koltsfocsop");
            koltsalcsopinfo = FakUserInterface.GetKodtab("C", "Koltsalcsop");
            koltscsopinfo = FakUserInterface.GetBySzintPluszTablanev("C", "KOLTSEGCSOPORT");
            koltsegkodok = FakUserInterface.GetBySzintPluszTablanev("C", "KOLTSEGKOD");
            termekkodok = FakUserInterface.GetBySzintPluszTablanev("C", "TERMEKKOD");
            termfocsopinfo = FakUserInterface.GetKodtab("C", "Termfocsop");
            termalcsopinfo=FakUserInterface.GetKodtab("C","Termalcsop");
            termcsopinfo = FakUserInterface.GetKodtab("C", "Termcsop");
            termekkodok = FakUserInterface.GetBySzintPluszTablanev("C", "TERMEKKOD");
            termfocsopalcsop = FakUserInterface.GetOsszef("C", "Termfocsopalcsop");
            termalcsopcsop = FakUserInterface.GetOsszef("C", "Termalcsopcsop");
            termcsopkod = FakUserInterface.GetOsszef("C", "Termcsopkod");
            koltsfocsopalcsop = FakUserInterface.GetOsszef("C", "Koltsfocsopalcsop");
            koltsalcsopcsop = FakUserInterface.GetOsszef("C", "Koltsalcsopcsop");
            koltscsopkod = FakUserInterface.GetOsszef("C", "Koltscsopkod");
            szazalekinfo = FakUserInterface.GetKodtab("C", "Fszazal");
            szazalekosfeloszt = FakUserInterface.GetCsoport("C", "Feloszt");
        }
        private void ujpartner_Click(object sender, EventArgs e)
        {
            if (ujpartnerform == null)
                ujpartnerform = new UjPartner();
            ujpartnerform.UjPartnerInit(AktivVezerles,VezerloControl, this.Name, szlainfo, partnerinfo, partner, FakUserInterface);
            if (ujpartnerform.ShowDialog() == DialogResult.OK)
            {
                VezerloControl.ComboSzures(this.Name, partner);
                Koltsegkodalapertelmezes();
            }
        }

        public override void Controloktolt(Controltipus egycont, bool force, bool kellchild, bool kellfocus)
        {
            if (egycont == szla)
            {
                szlainfo.DataView.RowFilter = "";
                szlainfo.DataView.Sort = "";
            }
            HozferJog = UserParamTabla.AktualTermeszetesJogosultsag;
            base.Controloktolt(egycont, force, kellchild, kellfocus);
            egycont.HozferJog = HozferJog;
            if (egycont == szla)
            {
                if (ValtozasLekerdez().Count != 0)
                    VezerloControl.ComboSzures(this.Name, partner);
                if (szlainfo.AktualViewRow == null && szlainfo.Adattabla.Rows.Count != 0)
                    szlainfo.ViewSorindex = 0;
                DatumokAllit(szlainfo.AktualViewRow);
            }
        }
        private void Koltsegkodalapertelmezes()
        {
            partnerid = FakUserInterface.GetTartal(partnerinfo, "PARTNER_ID", "SZOVEG", partner.Text)[0];
            partnerinfo.DataView.RowFilter = "PARTNER_ID =" + partnerid;
            DataRow dr = partnerinfo.DataView[0].Row;
            partnerinfo.DataView.RowFilter = "";
            egykoltsegid = dr["KOLTSEGKOD_ID"].ToString();
            if (egykoltsegid != "0")
            {
                Cols koltscol =koltsegkodtag.Egyinp;
                int id = koltscol.Combo_Info.ComboId.IndexOf(egykoltsegid);
                egykoltsegkod = koltscol.Combo_Info.ComboInfo[id].ToString();
                if (tetelinfo.ViewSorindex == -1)
                    koltsegkod.Text = egykoltsegkod;
            }
        }
        private void DatumokAllit(DataRow dr)
        {
            DateTime szladatum = UserParamTabla.SzamlaDatumtol;
            bruttoossz = 0;
            bruttoosszegzes = 0;
            maradekossz = 0;
            label9.Visible = false;
            kiegyenldat.Visible = false;
            szamladatum.MinDate = DateTimePicker.MinimumDateTime;
            szamladatum.MaxDate = DateTimePicker.MaximumDateTime;
            fizdatum.MinDate = DateTimePicker.MinimumDateTime;
            fizdatum.MaxDate = DateTimePicker.MaximumDateTime;
            teljdatum.MinDate = DateTimePicker.MinimumDateTime;
            teljdatum.MaxDate = DateTimePicker.MaximumDateTime;
            if (dr == null)
            {
                szamladatum.Value = szladatum;
                fizdatum.Value = szladatum;
                teljdatum.Value = szladatum;
            }
            else
            {
                szladatum = Convert.ToDateTime(dr["SZLA_DATUM"].ToString());
                szamladatum.Value = szladatum;
                fizdatum.Value = Convert.ToDateTime(dr["DATUM_FIZ"].ToString());
                teljdatum.Value = Convert.ToDateTime(dr["DATUM_TELJ"].ToString());
            }
            szamladatum.MinDate = UserParamTabla.SzamlaDatumtol;
            szamladatum.MaxDate = UserParamTabla.SzamlaDatumig;
            if (dr == null && fizdatum.Value.CompareTo(szladatum) < 0)
                fizdatum.Value = szladatum;
            fizdatum.MinDate = szladatum;
            string kovev = (UserParamTabla.SzamlaDatumig.Year + 1).ToString() + ".12.31";
            DateTime kovevvege = Convert.ToDateTime(kovev);
            fizdatum.MaxDate = kovevvege;
            if (dr == null && teljdatum.Value.CompareTo(szladatum) < 0)
                teljdatum.Value = szladatum;
            teljdatum.MinDate = szladatum;
            teljdatum.MaxDate = kovevvege;
            osszbrutto.ReadOnly = false;
            ArrayList ar = new ArrayList();
            DataRow dr1;
            for (int i = 0; i < szazalekosfeloszt.DataView.Count; i++)
            {
                dr1 = szazalekosfeloszt.DataView[i].Row;
                int j = ar.IndexOf(dr1["SORSZAM2"].ToString());
                if (j == -1)
                    ar.Add(dr1["SORSZAM2"].ToString());
            }
            semaidk = (string[])ar.ToArray(typeof(string));
            if (dr != null)
            {
                osszbrutto.ReadOnly = true;
                ujpartner.Visible = false;
                szladatum = Convert.ToDateTime(szlainfo.AktualViewRow["SZLA_DATUM"].ToString());
                bruttoossz = Convert.ToDecimal(szlainfo.AktualViewRow["OSSZKIADAS"].ToString());
                if (tetelinfo.DataView.Count != 0)
                {
                    if (dr["PENZTAR_ID"].ToString()=="0")
                    {
                        szlainfo.InputColumns["PENZTAR_ID"].Lehetures = true;
                        szlainfo.InputColumns["FOLYOSZAMLA_ID"].Lehetures = false;
                        penztar.Text = "";
                    }
                    else
                    {
                        szlainfo.InputColumns["PENZTAR_ID"].Lehetures = false;
                        szlainfo.InputColumns["FOLYOSZAMLA_ID"].Lehetures = true;
                        folyoszamla.Text = "";
                    }
                    if (fizetve.Checked)
                    {
                        label9.Visible = true;
                        kiegyenldat.Visible = true;
                    }
                }
            }
            else
            {
                osszbrutto.ReadOnly = false;
                szlainfo.InputColumns["PENZTAR_ID"].Lehetures = true;
                szlainfo.InputColumns["FOLYOSZAMLA_ID"].Lehetures = true;
                ujpartner.Visible = HozferJog==Base.HozferJogosultsag.Irolvas;
                penztar.Text = "";
                folyoszamla.SelectedIndex = 0;
                fizetve.Checked = false;
            }
            Koltsegkodalapertelmezes();
            SzamlainputokEnable(tetelinfo.DataView.Count == 0);
            for (int i = 0; i < tetelinfo.DataView.Count; i++)
                bruttoosszegzes += Convert.ToDecimal(tetelinfo.DataView[i].Row["KIADAS"].ToString());
            maradekossz = bruttoossz - bruttoosszegzes;
            if (Convert.ToInt64(maradekossz) <= 1)
                maradekossz = 0;
            maradek.Text = maradekossz.ToString();
            if (szla.InputGroupBox.Enabled)
                szla.InputGroupBox.Focus();
        }

        //public override void Beallit(Controltipus egycont, int viewindex, bool kellchild)
        //{
        //    base.Beallit(egycont, viewindex, kellchild);
        //    Tablainfo info = egycont.Tablainfo;
        //    //if (info == tetelinfo)
        //    //{
        //    //    string szov = afakulcs.Text;
        //    //    afakod = FakUserInterface.GetTartal(afainfo, "KOD", "SZOVEG", szov)[0];
        //    //    afaszazalek = Convert.ToInt32(afakod);
        //    //}
        //}
        private void SzamlainputokEnable(bool enable)
        {
            bool read_only = !enable;
            FakUserInterface.EventTilt = true;
            for (int i = 0; i < szla.MezoControlInfo.Inputeleminfok.Length; i++)
            {
                MezoTag egytag = szla.MezoControlInfo.Inputeleminfok[i];
                if (egytag.Control.Name != "fizetve")
                {
                    try
                    {
                        FormattedTextBox.FormattedTextBox ftb = (FormattedTextBox.FormattedTextBox)egytag.Control;
                        ftb.ReadOnly = read_only;
                    }
                    catch
                    {
                        try
                        {
                            TextBox tb = (TextBox)egytag.Control;
                            tb.ReadOnly = false;
                            tb.Enabled = enable;
                        }
                        catch
                        {
                            egytag.Control.Enabled = enable;
                        }
                    }
                }
            }
            FakUserInterface.EventTilt = false;
        }
        public override void GridView_CellMouseClick(object sender, DataGridViewCellMouseEventArgs e)
        {
            base.GridView_CellMouseClick(sender, e);
            DataGridView view = (DataGridView)sender;
            Controltipus conttip = ControltipusCollection.Find(view);
            if (conttip == szla)
            {
                DatumokAllit(szlainfo.AktualViewRow);
                SzamlainputokEnable(tetelinfo.DataView.Count == 0);
            }
        }
        public override bool EgyediValidalas(MezoTag egytag)
        {
            bool hiba = false;
            if (!sajateventtilt)
            {
                FakUserInterface.EventTilt = true;
                switch (egytag.Control.Name)
                {
                    case "partner":
                        Koltsegkodalapertelmezes();
                        break;
                    case "folyoszamla":
                        if (folyoszamla.Text != "")
                        {
                            penztar.Text = "";
                            fizetve.Checked = false;
                            label9.Visible = false;
                            kiegyenldat.Visible = false;
                        }
                        else if (penztar.Text == "")
                        {
                            penztar.SelectedIndex = 0;
                            fizetve.Checked = true;
                            label9.Visible = true;
                            kiegyenldat.Visible = true;
                            kiegyenldat.Value = szamladatum.Value;
                            kiegyenldat.Enabled = false;
                        }
                        break;
                    case "penztar":
                        if (penztar.Text != "")
                        {
                            folyoszamla.Text = "";
                            fizetve.Checked = true;
                            fizetve.Enabled = false;
                        }
                        else if (folyoszamla.Text == "")
                        {
                            folyoszamla.SelectedIndex = 0;
                            fizetve.Enabled = true;
                            fizetve.Checked = false;
                        }
                        break;
                    case "szamladatum":
                        if (szamladatum.Value.CompareTo(fizdatum.MinDate) != 0)
                            fizdatum.MinDate = UserParamTabla.SzamlaDatumtol;
                        if (fizdatum.Value.CompareTo(szamladatum.Value) < 0)
                            fizdatum.Value = szamladatum.Value;
                        fizdatum.MinDate = szamladatum.Value;
                        if (szamladatum.Value.CompareTo(teljdatum.MinDate) != 0)
                            teljdatum.MinDate = UserParamTabla.SzamlaDatumtol;
                        if (teljdatum.Value.CompareTo(szamladatum.Value) < 0)
                            teljdatum.Value = teljdatum.Value;
                        teljdatum.MinDate = szamladatum.Value;
                        break;
                    case "osszbrutto":
                        bruttoossz = Convert.ToDecimal(osszbrutto.Text);
                        break;
                    case "koltsegkod":
                        int id = koltsegkodtag.Egyinp.Combo_Info.ComboInfo.IndexOf(koltsegkod.Text);
                        string kodid = koltsegkodtag.Egyinp.Combo_Info.ComboIdk[id];
                        string termkod = FakUserInterface.GetTartal(koltsegkodok, "TERMEKKOD_ID", "KOLTSEGKOD_ID", kodid)[0];
                        id = termkodtag.Egycol.Combo_Info.ComboFileinfo.IndexOf(termkod);
                        string termkodid = termkodtag.Egyinp.Combo_Info.ComboIdk[id];
                        string[] csopidk = FakUserInterface.GetTartal(termcsopkod, "SORSZAM1", "SORSZAM2", termkodid);
                        if (csopidk != null)
                        {
                            termcsop.Text = FakUserInterface.GetTartal(termcsopinfo, "SZOVEG", "SORSZAM", csopidk[0])[0];
                            string[] alcsopidk = FakUserInterface.GetTartal(termalcsopcsop, "SORSZAM1", "SORSZAM2", csopidk[0]);
                            if (alcsopidk != null)
                            {
                                termalcsop.Text = FakUserInterface.GetTartal(termalcsopinfo, "SZOVEG", "SORSZAM", alcsopidk[0])[0];
                                string[] focsopidk = FakUserInterface.GetTartal(termfocsopalcsop, "SORSZAM1", "SORSZAM2", alcsopidk[0]);
                                if (focsopidk != null)
                                    termfocsop.Text = FakUserInterface.GetTartal(termfocsopinfo, "SZOVEG", "SORSZAM", focsopidk[0])[0];
                            }
                        }

                        afaid = FakUserInterface.GetTartal(koltsegkodok, "AFA_ID", "KOLTSEGKOD_ID", kodid)[0];
                        afakod = FakUserInterface.GetTartal(afainfo, "KOD", "SORSZAM", afaid)[0];
                        afaszov = FakUserInterface.GetTartal(afainfo, "SZOVEG", "SORSZAM", afaid)[0];
                        afakulcs.Text = afaszov;
                        afaszazalek = Convert.ToDecimal(afakod);
                        csopidk = FakUserInterface.GetTartal(koltscsopkod, "SORSZAM1", "SORSZAM2", kodid);
                        if (csopidk != null)
                        {
                            koltscsop.Text = FakUserInterface.GetTartal(koltscsopinfo, "SZOVEG", "KOLTSEGCSOPORT_ID", csopidk[0])[0];
                            string[] alcsopidk = FakUserInterface.GetTartal(koltsalcsopcsop, "SORSZAM1", "SORSZAM2", csopidk[0]);
                            if (alcsopidk != null)
                            {
                                koltsalcsop.Text = FakUserInterface.GetTartal(koltsalcsopinfo, "SZOVEG", "SORSZAM", alcsopidk[0])[0];
                                string[] focsopidk = FakUserInterface.GetTartal(koltsfocsopalcsop, "SORSZAM1", "SORSZAM2", alcsopidk[0]);
                                if (focsopidk != null)
                                    koltsfocsop.Text = FakUserInterface.GetTartal(koltsfocsopinfo, "SZOVEG", "SORSZAM", focsopidk[0])[0];
                            }
                        }
                        break;
                    case "netto":
                        hiba = Bruttoafaszamit(egytag);
                        break;
                }
                FakUserInterface.EventTilt = sajateventtilt;
            }
            return hiba;
        }
        private bool Bruttoafaszamit(MezoTag egytag)
        {
            Decimal egyafa;
            int viewindex;
            egynetto = Convert.ToDecimal(netto.Text);
            afaszazalek = Convert.ToDecimal(afakod) / 100;
            egyafa = egynetto * afaszazalek;
            egybrutto = egynetto + egyafa;
            afa.Text = egyafa.ToString();
            if (!afa.Text.Contains(","))
                afa.Text += ",00";
            brutto.Text = egybrutto.ToString();
            if (!brutto.Text.Contains(","))
                brutto.Text += ",00";
            bruttotag.SetValue(brutto.Text.ToString());
            ((MezoTag)afa.Tag).SetValue(afa.Text.ToString());
            bruttoosszegzes = 0;
            viewindex = tetelinfo.ViewSorindex;
            for (int i = 0; i < tetelinfo.DataView.Count; i++)
            {
                if (i != viewindex)
                    bruttoosszegzes += Convert.ToDecimal(tetelinfo.DataView[i].Row["KIADAS"].ToString());
            }
            bruttoosszegzes += egybrutto;
            maradekossz = bruttoossz - bruttoosszegzes;
            egytag.Hibaszov = "";
            if (maradekossz < -1)
                egytag.Hibaszov = " Maradék < 0!";
            else if (Convert.ToInt64(maradekossz) <= 1)
                maradekossz = 0;
            maradek.Text = maradekossz.ToString();
            return egytag.Hibaszov != "";
        }
        private void Nettoafaszamit()
        {
            afaszazalek = Convert.ToDecimal(afakod) / 100;
            egybrutto = Convert.ToDecimal(brutto.Text);
            egynetto = egybrutto / (1 + afaszazalek);
            egynetto = Decimal.Round(egynetto);
            netto.Text = egynetto.ToString();
            ((MezoTag)brutto.Tag).SetValue(brutto.Text);
            ((MezoTag)netto.Tag).SetValue(netto.Text);
            Decimal egyafa = egynetto * afaszazalek;
            afa.Text = egyafa.ToString();
            if (!afa.Text.Contains(","))
                afa.Text += ",00";
            ((MezoTag)afa.Tag).SetValue(afa.Text);
        }

        public override void ButtonokEnableAllit(Controltipus egycont, bool kellchild)
        {
            base.ButtonokEnableAllit(egycont, kellchild);
            if (Convert.ToDecimal(maradek.Text) == 0)
                uj12.Enabled = false;
            else
                uj12.Enabled = true;
            rogzit12.Enabled = false;
            elolrol1.Enabled = true;
            if (egycont == szlatetel && HozferJog == Base.HozferJogosultsag.Csakolvas)
                egycont.Panel.Enabled = true;
        }
        public override void Button_Click(object sender, EventArgs e)
        {
            sajateventtilt = true;
            FakUserInterface.EventTilt = true;
            base.Button_Click(sender, e);
            ToolStripButton egybut = (ToolStripButton)sender;
            ToolStrip owner = (ToolStrip)egybut.Owner;
            Controltipus conttip = ControltipusCollection.Find(owner);
            DataRow dr;
            if (conttip != null)
            {
                int i = conttip.ButtonokList.IndexOf(egybut);
                string butname = conttip.ButtonNevek[i];
                if (conttip == szla)
                {
                    switch (butname)
                    {
                        case "uj":
                            DatumokAllit(null);
                            break;
                        case "ok":
                            if (!szlainfo.ModositasiHiba && szlainfo.Valtozott)
                            {
                                ujpartner.Visible = false;
                                szlainfo.AktualViewRow["CEGHONAP_ID"] = UserParamTabla.Ceghonap_Id;
                                if (fizetve.Checked)
                                    szlainfo.AktualViewRow["KIEGYENL_DATUM"] = szamladatum.Value;
                                else
                                    szlainfo.AktualViewRow["KIEGYENL_DATUM"] = DBNull.Value;
                                if (tetelinfo.DataView.Count == 0)
                                {
                                    partnerid = FakUserInterface.GetTartal(partnerinfo, "PARTNER_ID", "SZOVEG", partner.Text)[0];
                                    partnerinfo.DataView.RowFilter = "PARTNER_ID =" + partnerid;
                                    dr = partnerinfo.DataView[0].Row;
                                    partnerinfo.DataView.RowFilter = "";
                                    SemaKiertekel(dr);
                                    if (tetelinfo.DataView.Count == 0)
                                    {
                                        if (egykoltsegid != "0")
                                        {
                                            Cols koltscol = koltsegkodtag.Egyinp;
                                            int id = koltscol.Combo_Info.ComboId.IndexOf(egykoltsegid);
                                            egykoltsegkod = koltscol.Combo_Info.ComboInfo[id].ToString();
                                            koltsegkod.Text = egykoltsegkod;
                                            megnevezes.Text = egykoltsegkod;
                                            afaidk = FakUserInterface.GetTartal(koltsegkodok, "AFA_ID", "KOLTSEGKOD_ID", egykoltsegid);
                                            if (afaidk != null)
                                            {
                                                afakod = FakUserInterface.GetTartal(afainfo, "KOD", "SORSZAM", afaidk[0])[0];
                                                afakulcs.Text = FakUserInterface.GetTartal(afainfo, "SZOVEG", "KOD", afakod)[0];
                                                afaszazalek = Convert.ToDecimal(afakod);
                                            }
                                            brutto.Text = osszbrutto.Text;
                                            Nettoafaszamit();
                                            if (!tetelinfo.ModositasiHiba)
                                            {
                                                FakUserInterface.EventTilt = true;
                                                Button_Click(ok12, e);
                                                base.Button_Click(rogzit1, e);
                                            }
                                        }
                                    }
                                    else
                                    {
                                        if (!Bruttoafaszamit(nettotag) && maradekossz == 0)
                                            base.Button_Click(rogzit1, e);
                                        DatumokAllit(szlainfo.AktualViewRow);
                                    }
                                }
                            }
                            break;
                        case "torol":
                            if (szlainfo.DataView.Count == 0)
                                ujpartner.Visible = HozferJog==Base.HozferJogosultsag.Irolvas;
                            break;
                        case "elolrol":
                            DatumokAllit(szlainfo.AktualViewRow);
                            szla.InputGroupBox.Enabled = true;
                            szla.InputGroupBox.Focus();
                            break;
                        case "elozo":
                            DatumokAllit(szlainfo.AktualViewRow);
                            break;
                        case "kovetkezo":
                            DatumokAllit(szlainfo.AktualViewRow);
                            break;
                    }
                }
                else
                {
                    switch (butname)
                    {
                        case "uj":
                            brutto.Text = maradek.Text;
                            koltsegkod.Text = egykoltsegkod;
                            megnevezes.Text = egykoltsegkod;
                            int id = koltsegkodtag.Egyinp.Combo_Info.ComboInfo.IndexOf(koltsegkod.Text);
                            string egyid = koltsegkodtag.Egyinp.Combo_Info.ComboId[id].ToString();
                            string[] afaidk = FakUserInterface.GetTartal(koltsegkodok, "AFA_ID", "KOLTSEGKOD_ID", egyid);
                            if (afaidk != null)
                            {
                                afakod = FakUserInterface.GetTartal(afainfo, "KOD", "SORSZAM", afaidk[0])[0];
                                afakulcs.Text = FakUserInterface.GetTartal(afainfo, "SZOVEG", "KOD", afakod)[0];
                            }
                            Nettoafaszamit();
                            break;
                        case "ok":
                            if (!tetelinfo.ModositasiHiba && tetelinfo.Valtozott)
                            {
                                dr = tetelinfo.AktualViewRow;
                                dr["CEGHONAP_ID"] = UserParamTabla.Ceghonap_Id;
                                dr["KOLTSSZLA_ID"] = szlainfo.AktualViewRow["KOLTSSZLA_ID"];
                                dr["KIADAS"] = brutto.Text;
                                dr["AFA"] = afa.Text;
                                int id1 = koltsegkodtag.Egyinp.Combo_Info.ComboInfo.IndexOf(koltsegkod.Text);
                                string kodid = koltsegkodtag.Egyinp.Combo_Info.ComboIdk[id1];
                                string termkod = FakUserInterface.GetTartal(koltsegkodok, "TERMEKKOD_ID", "KOLTSEGKOD_ID", kodid)[0];
                                dr["TERMEKKOD_ID"] = termkod;
                                id1 = termkodtag.Egycol.Combo_Info.ComboFileinfo.IndexOf(termkod);
                                string termkodid = termkodtag.Egyinp.Combo_Info.ComboIdk[id1];
                                termekkod.SelectedIndex = id1;
                                string[] csopidk = FakUserInterface.GetTartal(termcsopkod, "SORSZAM1", "SORSZAM2", termkodid);
                                if (csopidk != null)
                                {
                                    dr["TERMCSOP_ID"] = csopidk[0];
                                    termcsop.Text = FakUserInterface.GetTartal(termcsopinfo, "SZOVEG", "SORSZAM", csopidk[0])[0];
                                    string[] alcsopidk = FakUserInterface.GetTartal(termalcsopcsop, "SORSZAM1", "SORSZAM2", csopidk[0]);
                                    if (alcsopidk != null)
                                    {
                                        dr["TERMALCSOP_ID"] = alcsopidk[0];
                                        termalcsop.Text = FakUserInterface.GetTartal(termalcsopinfo, "SZOVEG", "SORSZAM", alcsopidk[0])[0];
                                        string[] focsopidk = FakUserInterface.GetTartal(termfocsopalcsop, "SORSZAM1", "SORSZAM2", alcsopidk[0]);
                                        if (focsopidk != null)
                                        {
                                            dr["TERMFOCSOP_ID"] = focsopidk[0];
                                            termfocsop.Text = FakUserInterface.GetTartal(termfocsopinfo, "SZOVEG", "SORSZAM", focsopidk[0])[0];
                                        }
                                    }
                                }

                                string afaid = FakUserInterface.GetTartal(koltsegkodok, "AFA_ID", "KOLTSEGKOD_ID", kodid)[0];
                                //                               afakulcs.SelectedIndex = afakulcs.Items.IndexOf(afaid);
                                string kod = FakUserInterface.GetTartal(afainfo, "KOD", "SORSZAM", afaid)[0];
                                afaszazalek = Convert.ToDecimal(kod);
                                csopidk = FakUserInterface.GetTartal(koltscsopkod, "SORSZAM1", "SORSZAM2", kodid);
                                if (csopidk != null)
                                {
                                    dr["KOLTSCSOP_ID"] = csopidk[0];
                                    koltscsop.Text = FakUserInterface.GetTartal(koltscsopinfo, "SZOVEG", "KOLTSEGCSOPORT_ID", csopidk[0])[0];
                                    string[] alcsopidk = FakUserInterface.GetTartal(koltsalcsopcsop, "SORSZAM1", "SORSZAM2", csopidk[0]);
                                    if (alcsopidk != null)
                                    {
                                        dr["KOLTSALCSOP_ID"] = alcsopidk[0];
                                        koltsalcsop.Text = FakUserInterface.GetTartal(koltsalcsopinfo, "SZOVEG", "SORSZAM", alcsopidk[0])[0];
                                        string[] focsopidk = FakUserInterface.GetTartal(koltsfocsopalcsop, "SORSZAM1", "SORSZAM2", alcsopidk[0]);
                                        if (focsopidk != null)
                                        {
                                            dr["KOLTSFOCSOP_ID"] = focsopidk[0];
                                            koltsfocsop.Text = FakUserInterface.GetTartal(koltsfocsopinfo, "SZOVEG", "SORSZAM", focsopidk[0])[0];
                                        }
                                    }
                                }
                                bruttoosszegzes = 0;
                                for (int j = 0; j < tetelinfo.DataView.Count; j++)
                                    bruttoosszegzes += Convert.ToDecimal(tetelinfo.DataView[j].Row["KIADAS"].ToString());
                                maradekossz = bruttoossz - bruttoosszegzes;
                                if (Convert.ToInt64(maradekossz) <= 1)
                                    maradekossz = 0;
                                maradek.Text = maradekossz.ToString();
                                if (maradekossz == 0)
                                {
  //                                  uj12.Visible = false;
                                    uj12.Enabled = false;
                                }
                                else
                                {
                                    Button_Click(uj12, e);
                                }

                            }
                            break;
                        default:
                            bruttoossz = Convert.ToDecimal(osszbrutto.Text);
                            bruttoosszegzes = 0;
                            for (int j = 0; j < tetelinfo.DataView.Count; j++)
                                bruttoosszegzes += Convert.ToDecimal(tetelinfo.DataView[j].Row["KIADAS"].ToString());
                            maradekossz = bruttoossz - bruttoosszegzes;
                            if (Convert.ToInt64(maradekossz) <= 1)
                                maradekossz = 0;
                            if (maradekossz == 0)
                                uj12.Enabled = false;
                            maradek.Text = maradekossz.ToString();
                            if (maradekossz == 0)
                            {
 //                               uj12.Visible = false;
                                uj12.Enabled = false;
                            }
                            else
                            {
                                base.Button_Click(uj12, e);
                                Button_Click(uj12, e);
                            }
                            break;

                    }
                }
            }
            FakUserInterface.EventTilt = false;
            sajateventtilt = false;
        }
        public override bool RogzitesElott()
        {
            return VezerloControl.RogzitesElott();
        }
        private void SemaKiertekel(DataRow dr)
        {
            string semaid = dr["SEMA_ID"].ToString();
            if (semaid != "" && semaid != "0")
            {

                int osszazalek = 0;
                koltscsopkod.DataView.RowFilter = "SORSZAM1=" + semaid;
                int count = koltscsopkod.DataView.Count;
                ArrayList koltsidk = new ArrayList();
                string koltsid;
                ArrayList szazalekok = new ArrayList();
                ArrayList szovegek = new ArrayList();
                string szoveg;
                ArrayList afaidkar = new ArrayList();
                ArrayList afaszovegek = new ArrayList();

                for (int ii = 0; ii < count; ii++)
                {
                    DataRow dr1 = koltscsopkod.DataView[ii].Row;
                    koltsid = dr1["SORSZAM2"].ToString();
                    szoveg = FakUserInterface.GetTartal(koltsegkodok, "SZOVEG", "KOLTSEGKOD_ID", koltsid)[0];
                    string id = dr1["SORSZAM"].ToString();
                    string[] szazalidk = FakUserInterface.GetTartal(szazalekosfeloszt, "SORSZAM2", "SORSZAM1", id);
                    if (szazalidk != null && szazalidk[0]!="0")
                    {
                        koltsidk.Add(koltsid);
                        string kod = FakUserInterface.GetTartal(szazalekinfo, "KOD", "SORSZAM", szazalidk[0])[0];
                        szazalekok.Add(kod);
                        osszazalek = osszazalek + Convert.ToInt32(kod);
                        szovegek.Add(szoveg);
                        afaidk = FakUserInterface.GetTartal(koltsegkodok, "AFA_ID", "KOLTSEGKOD_ID", koltsid);
                        for (int j = 0; j < afaidk.Length; j++)
                        {
                            egyafa = FakUserInterface.GetTartal(afainfo, "KOD", "SORSZAM", afaidk[j])[0];
                            afaidkar.Add(egyafa);
                            afaszovegek.Add(FakUserInterface.GetTartal(afainfo, "SZOVEG", "KOD", egyafa)[0]);
                        }
                    }
                }
                koltscsopkod.DataView.RowFilter = "";
                if (szazalekok.Count == 0)
                    return;
                decimal[] bruttok = new decimal[szazalekok.Count];
                decimal[] afak = new decimal[szazalekok.Count];
                decimal[] nettok = new decimal[szazalekok.Count];
                bruttoossz = Convert.ToDecimal(szlainfo.AktualViewRow["OSSZKIADAS"].ToString());
                decimal afaszazal = Convert.ToDecimal(afaidkar[0].ToString());
                decimal nettoossz = Decimal.Round((bruttoossz / (1 + afaszazal / 100)), 0);
                decimal bmaradek = bruttoossz;
                for (int ii = 0; ii < szazalekok.Count; ii++)
                {
                    decimal egyszazal = Convert.ToDecimal(szazalekok[ii].ToString());
                    nettok[ii] = nettoossz * egyszazal / 100;
                    afaszazal = Convert.ToDecimal(afaidkar[ii].ToString());
                    afak[ii] = nettok[ii] * afaszazal / 100;
                    bruttok[ii] = nettok[ii] + afak[ii];
                    //                                           nettok[ii] = Decimal.Round((bruttok[ii] * 100 / (100 + afaszazal)), 0);
                    //                           Decimal egyafa = egynetto * afaszazalek / 100;

                    //                            nettok[ii] = Decimal.Round(( nettoossz / 100 * egyszazal),0);
                    //                                            afak[ii] = Decimal.Round((nettok[ii] * afaszazal / 100), 0);
                    //                                           bruttok[ii] = nettok[ii] + afak[ii];
                    bmaradek = bmaradek - bruttok[ii];
                    Cols koltscol = koltsegkodtag.Egyinp;
                    int id = koltscol.Combo_Info.ComboId.IndexOf(koltsidk[ii]);
                    //egykoltsegkod = koltscol.Combo_Info.ComboInfo[id].ToString();
                    egykoltsegkod = szovegek[ii].ToString();
                    koltsegkod.Text = egykoltsegkod;
                    megnevezes.Text = egykoltsegkod;
                    afakulcs.Text = afaszovegek[ii].ToString();
                    brutto.Text = bruttok[ii].ToString();
                    netto.Text = nettok[ii].ToString();
                    afa.Text = afak[ii].ToString();
                    Button_Click(ok12, new EventArgs());
                    if (ii != szazalekok.Count - 1)
                        Button_Click(uj12, new EventArgs());
                    else
                    {
                    }
                }
            }

        }
    }
}
